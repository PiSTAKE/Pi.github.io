<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
  <title>Owner æ§åˆ¶å°</title>
  <link rel="stylesheet" href="index.css">
  <style>
    .admin-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    .admin-card {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: var(--shadow);
    }
    .admin-card h3 {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 16px;
      color: #222;
      border-bottom: 2px solid var(--primary);
      padding-bottom: 8px;
    }
    .admin-input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      box-sizing: border-box;
      margin-bottom: 12px;
      transition: border-color 0.3s;
    }
    .admin-input:focus {
      border-color: var(--primary);
      outline: none;
    }
    .admin-select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      box-sizing: border-box;
      margin-bottom: 12px;
      background: #fff;
      cursor: pointer;
    }
    .admin-btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 24px;
      background: linear-gradient(135deg, var(--primary), var(--sub));
      color: #fff;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 2px 8px rgba(112, 52, 255, 0.3);
    }
    .admin-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(112, 52, 255, 0.4);
    }
    .admin-btn:active {
      transform: translateY(0);
    }
    .admin-result {
      margin-top: 12px;
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      min-height: 20px;
    }
    .admin-result.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .admin-result.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .admin-result.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    .status-bar {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 24px;
      box-shadow: var(--shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }
    .status-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .status-label {
      font-size: 14px;
      color: var(--gray);
    }
    .status-value {
      font-size: 16px;
      font-weight: 700;
      color: var(--primary);
    }
    .owner-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: linear-gradient(135deg, #FFD700, #FF8C00);
      color: #fff;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
    }
  </style>
</head>
<body>
  <div class="admin-container">
    <!-- çŠ¶æ€æ  -->
    <div class="status-bar">
      <div class="status-item">
        <span class="status-label">è¿æ¥çŠ¶æ€:</span>
        <span class="status-value" id="connectionStatus">æœªè¿æ¥</span>
      </div>
      <div class="status-item">
        <span class="status-label">å½“å‰åœ°å€:</span>
        <span class="status-value" id="currentAddress">-</span>
      </div>
      <div class="status-item" id="ownerStatus" style="display:none;">
        <span class="owner-badge">ğŸ‘‘ Owner</span>
      </div>
      <button id="btnConnect" class="admin-btn" onclick="connectWallet()" style="width:auto;padding:10px 20px;margin:0;">
        <span id="btnConnectText">è¿æ¥é’±åŒ…</span>
      </button>
    </div>

    <!-- Owneræƒé™æ£€æŸ¥ -->
    <div class="admin-card" id="ownerCheckCard">
      <h3>æƒé™æ£€æŸ¥</h3>
      <div id="ownerCheck" style="text-align:center;padding:20px;">
        <p style="color:#999;">è¯·å…ˆè¿æ¥é’±åŒ…ä»¥æ£€æŸ¥Owneræƒé™</p>
      </div>
    </div>

    <!-- ç®¡ç†é¢æ¿ -->
    <div id="adminPanel" style="display:none;">
      <!-- å¢åŠ ç”¨æˆ·Piä½™é¢ -->
      <div class="admin-card">
        <h3>å¢åŠ ç”¨æˆ·Piä½™é¢</h3>
        <input id="adminUserAddress" type="text" placeholder="ç”¨æˆ·åœ°å€ (0x...)" class="admin-input">
        <input id="adminPiAmount" type="number" step="0.01" placeholder="Piæ•°é‡" class="admin-input">
        <button onclick="adminAddPi()" class="admin-btn">å¢åŠ Pi</button>
        <div id="adminPiResult" class="admin-result"></div>
      </div>

      <!-- å¢åŠ ç”¨æˆ·å‹‹ç«  -->
      <div class="admin-card">
        <h3>å¢åŠ ç”¨æˆ·å‹‹ç« </h3>
        <input id="adminMedalUser" type="text" placeholder="ç”¨æˆ·åœ°å€ (0x...)" class="admin-input">
        <select id="adminMedalType" class="admin-select">
          <option value="0">é»„é‡‘å‹‹ç«  (30U)</option>
          <option value="1">é’»çŸ³å‹‹ç«  (100U)</option>
          <option value="2">é»‘é’»å‹‹ç«  (200U)</option>
        </select>
        <input id="adminMedalAmount" type="number" step="0.01" placeholder="è´¨æŠ¼é‡‘é¢(U)" class="admin-input">
        <button onclick="adminAddMedal()" class="admin-btn">å¢åŠ å‹‹ç« </button>
        <div id="adminMedalResult" class="admin-result"></div>
      </div>

      <!-- è®¾ç½®å•†å“ä»·æ ¼ -->
      <div class="admin-card">
        <h3>è®¾ç½®å•†å“ä»·æ ¼</h3>
        <input id="adminProductIndex" type="number" min="0" max="13" placeholder="å•†å“ç´¢å¼• (0-13)" class="admin-input">
        <input id="adminProductPrice" type="number" step="0.01" placeholder="ä»·æ ¼(Pi)" class="admin-input">
        <button onclick="adminSetProductPrice()" class="admin-btn">è®¾ç½®ä»·æ ¼</button>
        <div id="adminProductResult" class="admin-result"></div>
      </div>

      <!-- è®¾ç½®å‘è´§åœ°å€ -->
      <div class="admin-card">
        <h3>è®¾ç½®å‘è´§åœ°å€</h3>
        <input id="adminShippingAddress" type="text" placeholder="å‘è´§åœ°å€" class="admin-input">
        <button onclick="adminSetShippingAddress()" class="admin-btn">è®¾ç½®åœ°å€</button>
        <div id="adminShippingResult" class="admin-result"></div>
      </div>

      <!-- è®¾ç½®è®¡æ•°å™¨åˆå§‹å€¼ -->
      <div class="admin-card">
        <h3>è®¾ç½®è®¡æ•°å™¨åˆå§‹å€¼</h3>
        <input id="adminGlobalCount" type="number" placeholder="å…¨çƒå‹‹ç« æ•°é‡" class="admin-input">
        <input id="adminRegionCount" type="number" placeholder="æ‰€åœ¨åœ°åŒºé»„é‡‘å‹‹ç« æ•°é‡" class="admin-input">
        <button onclick="adminSetCounters()" class="admin-btn">è®¾ç½®è®¡æ•°å™¨</button>
        <div id="adminCounterResult" class="admin-result"></div>
      </div>
    </div>
  </div>

  <!-- ethers.js -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script>
    const contractAddress = "0x077F10970ee4Bb9f6b34467408418E421faecc0e";
    const abi = [
      "function owner() view returns(address)",
      "function addUserPiBalance(address,uint256)",
      "function addUserMedal(address,uint256,uint256)",
      "function setProductPrice(uint256,uint256)",
      "function setShippingFromAddress(string)",
      "function setCounterInitialValues(uint256,uint256)"
    ];
    
    let provider, signer, contract, myAddr, isOwner = false;

    async function connectWallet() {
      if (!window.ethereum) {
        alert('è¯·å®‰è£… MetaMask');
        return;
      }
      
      try {
        await ethereum.request({ method: 'eth_requestAccounts' });
        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();
        myAddr = await signer.getAddress();
        
        document.getElementById('currentAddress').innerText = myAddr.slice(0, 6) + '...' + myAddr.slice(-4);
        document.getElementById('connectionStatus').innerText = 'å·²è¿æ¥';
        document.getElementById('connectionStatus').style.color = '#4caf50';
        document.getElementById('btnConnectText').innerText = 'å·²è¿æ¥';
        document.getElementById('btnConnect').style.background = '#4caf50';
        
        contract = new ethers.Contract(contractAddress, abi, signer);
        
        // æ£€æŸ¥Owneræƒé™
        await checkOwner();
      } catch (e) {
        console.error('è¿æ¥å¤±è´¥:', e);
        alert('è¿æ¥é’±åŒ…å¤±è´¥: ' + e.message);
      }
    }

    async function checkOwner() {
      if (!contract) return;
      
      try {
        const ownerCheckEl = document.getElementById('ownerCheck');
        ownerCheckEl.innerHTML = '<p style="color:#06c;">æ£€æŸ¥æƒé™ä¸­...</p>';
        
        const owner = await contract.owner();
        isOwner = owner.toLowerCase() === myAddr.toLowerCase();
        
        if (isOwner) {
          document.getElementById('ownerStatus').style.display = 'flex';
          document.getElementById('ownerCheckCard').style.display = 'none';
          document.getElementById('adminPanel').style.display = 'block';
          ownerCheckEl.innerHTML = '<p style="color:#4caf50;font-weight:700;">âœ“ æ‚¨æ‹¥æœ‰Owneræƒé™</p>';
        } else {
          document.getElementById('ownerStatus').style.display = 'none';
          document.getElementById('adminPanel').style.display = 'none';
          ownerCheckEl.innerHTML = '<p style="color:#f00;font-weight:700;">âœ— æ‚¨ä¸æ˜¯Ownerï¼Œæ— æƒè®¿é—®æ­¤æ§åˆ¶å°</p>';
        }
      } catch (e) {
        console.error('æ£€æŸ¥æƒé™å¤±è´¥:', e);
        document.getElementById('ownerCheck').innerHTML = '<p style="color:#f00;">æ£€æŸ¥æƒé™å¤±è´¥: ' + e.message + '</p>';
      }
    }

    async function adminAddPi() {
      if (!isOwner || !contract) {
        alert('è¯·å…ˆè¿æ¥é’±åŒ…å¹¶ç¡®è®¤Owneræƒé™');
        return;
      }
      
      const userAddress = document.getElementById('adminUserAddress').value.trim();
      const piAmount = document.getElementById('adminPiAmount').value;
      const resultEl = document.getElementById('adminPiResult');
      
      if (!userAddress || !piAmount) {
        resultEl.className = 'admin-result error';
        resultEl.innerText = 'è¯·å¡«å†™å®Œæ•´ä¿¡æ¯';
        return;
      }
      
      try {
        resultEl.className = 'admin-result info';
        resultEl.innerText = 'å¤„ç†ä¸­...';
        
        const amountInWei = ethers.utils.parseUnits(piAmount, 18);
        const tx = await contract.addUserPiBalance(userAddress, amountInWei);
        resultEl.innerText = 'äº¤æ˜“å·²æäº¤ï¼Œç­‰å¾…ç¡®è®¤...';
        
        await tx.wait();
        resultEl.className = 'admin-result success';
        resultEl.innerText = 'âœ“ æˆåŠŸå¢åŠ  ' + piAmount + ' Pi åˆ°ç”¨æˆ· ' + userAddress.slice(0, 6) + '...' + userAddress.slice(-4);
        
        document.getElementById('adminUserAddress').value = '';
        document.getElementById('adminPiAmount').value = '';
      } catch (e) {
        console.error('å¢åŠ Piå¤±è´¥:', e);
        resultEl.className = 'admin-result error';
        resultEl.innerText = 'å¤±è´¥: ' + (e.message || e.reason || 'æœªçŸ¥é”™è¯¯');
      }
    }

    async function adminAddMedal() {
      if (!isOwner || !contract) {
        alert('è¯·å…ˆè¿æ¥é’±åŒ…å¹¶ç¡®è®¤Owneræƒé™');
        return;
      }
      
      const userAddress = document.getElementById('adminMedalUser').value.trim();
      const medalType = parseInt(document.getElementById('adminMedalType').value);
      const amountU = document.getElementById('adminMedalAmount').value;
      const resultEl = document.getElementById('adminMedalResult');
      
      if (!userAddress || !amountU) {
        resultEl.className = 'admin-result error';
        resultEl.innerText = 'è¯·å¡«å†™å®Œæ•´ä¿¡æ¯';
        return;
      }
      
      try {
        resultEl.className = 'admin-result info';
        resultEl.innerText = 'å¤„ç†ä¸­...';
        
        const amountInWei = ethers.utils.parseUnits(amountU, 18);
        const tx = await contract.addUserMedal(userAddress, medalType, amountInWei);
        resultEl.innerText = 'äº¤æ˜“å·²æäº¤ï¼Œç­‰å¾…ç¡®è®¤...';
        
        await tx.wait();
        const medalNames = ['é»„é‡‘å‹‹ç« ', 'é’»çŸ³å‹‹ç« ', 'é»‘é’»å‹‹ç« '];
        resultEl.className = 'admin-result success';
        resultEl.innerText = 'âœ“ æˆåŠŸä¸ºç”¨æˆ· ' + userAddress.slice(0, 6) + '...' + userAddress.slice(-4) + ' å¢åŠ  ' + medalNames[medalType];
        
        document.getElementById('adminMedalUser').value = '';
        document.getElementById('adminMedalAmount').value = '';
      } catch (e) {
        console.error('å¢åŠ å‹‹ç« å¤±è´¥:', e);
        resultEl.className = 'admin-result error';
        resultEl.innerText = 'å¤±è´¥: ' + (e.message || e.reason || 'æœªçŸ¥é”™è¯¯');
      }
    }

    async function adminSetProductPrice() {
      if (!isOwner || !contract) {
        alert('è¯·å…ˆè¿æ¥é’±åŒ…å¹¶ç¡®è®¤Owneræƒé™');
        return;
      }
      
      const productIndex = parseInt(document.getElementById('adminProductIndex').value);
      const price = document.getElementById('adminProductPrice').value;
      const resultEl = document.getElementById('adminProductResult');
      
      if (productIndex < 0 || productIndex > 13 || !price) {
        resultEl.className = 'admin-result error';
        resultEl.innerText = 'è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼ˆå•†å“ç´¢å¼•0-13ï¼‰';
        return;
      }
      
      try {
        resultEl.className = 'admin-result info';
        resultEl.innerText = 'å¤„ç†ä¸­...';
        
        const priceInWei = ethers.utils.parseUnits(price, 18);
        const tx = await contract.setProductPrice(productIndex, priceInWei);
        resultEl.innerText = 'äº¤æ˜“å·²æäº¤ï¼Œç­‰å¾…ç¡®è®¤...';
        
        await tx.wait();
        resultEl.className = 'admin-result success';
        resultEl.innerText = 'âœ“ æˆåŠŸè®¾ç½®å•†å“ #' + productIndex + ' çš„ä»·æ ¼ä¸º ' + price + ' Pi';
        
        document.getElementById('adminProductIndex').value = '';
        document.getElementById('adminProductPrice').value = '';
      } catch (e) {
        console.error('è®¾ç½®ä»·æ ¼å¤±è´¥:', e);
        resultEl.className = 'admin-result error';
        resultEl.innerText = 'å¤±è´¥: ' + (e.message || e.reason || 'æœªçŸ¥é”™è¯¯');
      }
    }

    async function adminSetShippingAddress() {
      if (!isOwner || !contract) {
        alert('è¯·å…ˆè¿æ¥é’±åŒ…å¹¶ç¡®è®¤Owneræƒé™');
        return;
      }
      
      const address = document.getElementById('adminShippingAddress').value.trim();
      const resultEl = document.getElementById('adminShippingResult');
      
      if (!address) {
        resultEl.className = 'admin-result error';
        resultEl.innerText = 'è¯·å¡«å†™å‘è´§åœ°å€';
        return;
      }
      
      try {
        resultEl.className = 'admin-result info';
        resultEl.innerText = 'å¤„ç†ä¸­...';
        
        const tx = await contract.setShippingFromAddress(address);
        resultEl.innerText = 'äº¤æ˜“å·²æäº¤ï¼Œç­‰å¾…ç¡®è®¤...';
        
        await tx.wait();
        resultEl.className = 'admin-result success';
        resultEl.innerText = 'âœ“ æˆåŠŸè®¾ç½®å‘è´§åœ°å€: ' + address;
        
        document.getElementById('adminShippingAddress').value = '';
      } catch (e) {
        console.error('è®¾ç½®åœ°å€å¤±è´¥:', e);
        resultEl.className = 'admin-result error';
        resultEl.innerText = 'å¤±è´¥: ' + (e.message || e.reason || 'æœªçŸ¥é”™è¯¯');
      }
    }

    async function adminSetCounters() {
      if (!isOwner || !contract) {
        alert('è¯·å…ˆè¿æ¥é’±åŒ…å¹¶ç¡®è®¤Owneræƒé™');
        return;
      }
      
      const globalCount = document.getElementById('adminGlobalCount').value;
      const regionCount = document.getElementById('adminRegionCount').value;
      const resultEl = document.getElementById('adminCounterResult');
      
      if (!globalCount || !regionCount) {
        resultEl.className = 'admin-result error';
        resultEl.innerText = 'è¯·å¡«å†™å®Œæ•´ä¿¡æ¯';
        return;
      }
      
      try {
        resultEl.className = 'admin-result info';
        resultEl.innerText = 'å¤„ç†ä¸­...';
        
        const tx = await contract.setCounterInitialValues(globalCount, regionCount);
        resultEl.innerText = 'äº¤æ˜“å·²æäº¤ï¼Œç­‰å¾…ç¡®è®¤...';
        
        await tx.wait();
        resultEl.className = 'admin-result success';
        resultEl.innerText = 'âœ“ æˆåŠŸè®¾ç½®è®¡æ•°å™¨: å…¨çƒ=' + globalCount + ', åœ°åŒº=' + regionCount;
        
        document.getElementById('adminGlobalCount').value = '';
        document.getElementById('adminRegionCount').value = '';
      } catch (e) {
        console.error('è®¾ç½®è®¡æ•°å™¨å¤±è´¥:', e);
        resultEl.className = 'admin-result error';
        resultEl.innerText = 'å¤±è´¥: ' + (e.message || e.reason || 'æœªçŸ¥é”™è¯¯');
      }
    }

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦å·²è¿æ¥é’±åŒ…
    window.addEventListener('load', () => {
      if (window.ethereum && window.ethereum.selectedAddress) {
        connectWallet();
      }
    });
  </script>
</body>
</html>

