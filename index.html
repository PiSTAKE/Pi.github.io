<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
  <title>Pi</title>
  <link rel="stylesheet" href="index.css">
</head>
<body>
  <!-- è¿æ¥é’±åŒ…åœ†å½¢æŒ‰é’® -->
  <button id="btnConnect" class="connect-btn" onclick="connectWallet()" title="è¿æ¥é’±åŒ…">ğŸ”—</button>

  <!-- é¦–é¡µ -->
  <section id="home" class="page active">
    <img class="banner" src="logo3.png" alt="banner å ä½">
    <div class="btn-row">
      <button class="btn-primary" onclick="location.hash='#notice'">å¹³å°å…¬å‘Š</button>
      <button class="btn-line">å…¨ç½‘å…¬æµ‹ä¸Šçº¿</button>
    </div>

    <h3 class="title">æˆ‘çš„å‹‹ç« </h3>
    <div class="medal-box">
      <div id="medalContainer" style="display:flex;justify-content:center;align-items:center;gap:20px;flex-wrap:wrap;min-height:150px;">
        <!-- å‹‹ç« å›¾ç‰‡å°†åŠ¨æ€æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
      </div>
      <p>æˆ‘çš„å‹‹ç« æ€»æ•°ï¼š<b id="myMedals">0</b></p>
      <p style="font-size:12px;color:#666;margin-top:4px;" id="medalDetail">é»„é‡‘:0 é’»çŸ³:0 é»‘é’»:0</p>
    </div>

    <div class="pi-price-box">
      <p class="pi-price-text">Piä¸€æšå€¼: <span class="pi-price-value">314159$</span></p>
    </div>

    <div class="grid-2">
      <div class="card">
        <span class="big-purple" id="totalMedals">0</span>
        <p class="sub">å…¨çƒå‹‹ç« æ•°é‡</p>
      </div>

      <div class="card card-right" onclick="goPledge()" style="cursor:pointer;">
        <span class="big-purple" id="myPledgeU">è´¨æŠ¼</span>
        <p class="sub">å»è´¨æŠ¼&gt;</p>
        <img id="pledgeCardImg" class="corner-img" src="0xz.png" alt="å‹‹ç« ">
      </div>

      <div class="card">
        <span class="big-purple" id="teamMedals">0</span>
        <p class="sub">æ‰€åœ¨åœ°åŒºé»„é‡‘å‹‹ç« æ•°é‡</p>
      </div>

      <div class="card card-right" onclick="location.hash='#points'" style="cursor:pointer;">
        <span class="big-purple">Pi</span>
        <p class="sub">Piæ˜ç»†&gt;</p>
        <img id="pointsCardImg" class="corner-img" src="0xz.png" alt="å‹‹ç« ">
      </div>

      
    </div>
  </section>

  <!-- å•†åŸ -->
  <section id="mall" class="page">
    <h3 class="title">å•†å“åŒº</h3>
    <img class="banner" src="logo4.png" alt="å•†åŸå¤´å›¾å ä½">

    <h3 class="title" style="margin-top:24px;font-size:18px;color:var(--primary);">é»„é‡‘åŒºåŸŸ</h3>
    <div class="grid-2">
      <div class="goods-card" onclick="goExchange(0, '0.jpg', 'å®«å»·å¤æ³•é»„é‡‘æˆ’æŒ‡ è¶³é‡‘999-55g', '0.45')" style="cursor:pointer;">
        <img src="0.jpg" alt="">
        <div class="g-info">
          <p>å®«å»·å¤æ³•é»„é‡‘æˆ’æŒ‡ è¶³é‡‘999-55g</p>
          <p class="price">Piï¼š0.45</p>
        </div>
      </div>
      <div class="goods-card" onclick="goExchange(1, '1.png', 'å®«å»·å¤æ³•é»„é‡‘æ‰‹é•¯ è¶³é‡‘999-100g', '0.8')" style="cursor:pointer;">
        <img src="1.png" alt="">
        <div class="g-info">
          <p>å®«å»·å¤æ³•é»„é‡‘æ‰‹é•¯ è¶³é‡‘999-100g</p>
          <p class="price">Piï¼š0.8</p>
        </div>
      </div>
      <div class="goods-card" onclick="goExchange(2, '2.png', 'ä¸­å›½é»„é‡‘-é‡‘æ¡-è¶³é‡‘999-3Kg', '2.8')" style="cursor:pointer;">
        <img src="2.png" alt="">
        <div class="g-info">
          <p>ä¸­å›½é»„é‡‘-é‡‘æ¡-è¶³é‡‘999-3Kg</p>
          <p class="price">Piï¼š2.8</p>
        </div>
      </div>
      <div class="goods-card" onclick="goExchange(14, '14.png', 'ç¿¡ç¿ ç‰çŸ³', '18.88')" style="cursor:pointer;">
        <img src="14.png" alt="">
        <div class="g-info">
          <p>ç¿¡ç¿ ç‰çŸ³</p>
          <p class="price">Piï¼š18.88</p>
        </div>
      </div>
    </div>

    <h3 class="title" style="margin-top:24px;font-size:18px;color:var(--primary);">è½¦äº§åŒºåŸŸ</h3>
    <div class="grid-2">
      <div class="goods-card" onclick="goExchange(3, '3.png', 'ç‰¹æ–¯æ‹‰ Model S', '1.5')" style="cursor:pointer;">
        <img src="3.png" alt="">
        <div class="g-info">
          <p>ç‰¹æ–¯æ‹‰ Model S</p>
          <p class="price">Piï¼š1.5</p>
        </div>
      </div>
      <div class="goods-card" onclick="goExchange(4, '4.png', 'ä¸°ç”°é˜¿å°”æ³•å•†åŠ¡è½¦', '1.8')" style="cursor:pointer;">
        <img src="4.png" alt="">
        <div class="g-info">
          <p>ä¸°ç”°é˜¿å°”æ³•å•†åŠ¡è½¦</p>
          <p class="price">Piï¼š1.8</p>
        </div>
      </div>
      <div class="goods-card" onclick="goExchange(5, '5.png', 'åä¸ºM9', '2.8')" style="cursor:pointer;">
        <img src="5.png" alt="">
        <div class="g-info">
          <p>åä¸ºM9</p>
          <p class="price">Piï¼š2.8</p>
        </div>
      </div>
      <div class="goods-card" onclick="goExchange(15, '15.png', 'çº¢æ——æ±½è½¦', '8.88')" style="cursor:pointer;">
        <img src="15.png" alt="">
        <div class="g-info">
          <p>çº¢æ——æ±½è½¦</p>
          <p class="price">Piï¼š8.88</p>
        </div>
      </div>
      <div class="goods-card" onclick="goExchange(10, '10.png', 'å®¾åˆ©', '12.8')" style="cursor:pointer;">
        <img src="10.png" alt="">
        <div class="g-info">
          <p>å®¾åˆ©</p>
          <p class="price">Piï¼š12.8</p>
        </div>
      </div>
      <div class="goods-card" onclick="goExchange(11, '11.png', 'è¿ˆå·´èµ«', '13.8')" style="cursor:pointer;">
        <img src="11.png" alt="">
        <div class="g-info">
          <p>è¿ˆå·´èµ«</p>
          <p class="price">Piï¼š13.8</p>
        </div>
      </div>
      <div class="goods-card" onclick="goExchange(12, '12.png', 'åŠ³æ–¯è±æ–¯', '14.8')" style="cursor:pointer;">
        <img src="12.png" alt="">
        <div class="g-info">
          <p>åŠ³æ–¯è±æ–¯</p>
          <p class="price">Piï¼š14.8</p>
        </div>
      </div>
      <div class="goods-card" onclick="goExchange(13, '13.png', 'æ³•æ‹‰åˆ©', '31.9')" style="cursor:pointer;">
        <img src="13.png" alt="">
        <div class="g-info">
          <p>æ³•æ‹‰åˆ©</p>
          <p class="price">Piï¼š31.9</p>
        </div>
      </div>
    </div>

    <h3 class="title" style="margin-top:24px;font-size:18px;color:var(--primary);">æˆ¿äº§åŒºåŸŸ</h3>
    <div class="grid-2">
      <div class="goods-card" onclick="goExchange(6, '6.png', 'ç¬¬4ä»£ç©ºä¸­èŠ±å›­æˆ¿', '8')" style="cursor:pointer;">
        <img src="6.png" alt="">
        <div class="g-info">
          <p>ç¬¬4ä»£ç©ºä¸­èŠ±å›­æˆ¿</p>
          <p class="price">Piï¼š8</p>
        </div>
      </div>
      <div class="goods-card" onclick="goExchange(7, '7.png', 'ç¬¬4ä»£ç©ºä¸­èŠ±å›­æˆ¿', '12')" style="cursor:pointer;">
        <img src="7.png" alt="">
        <div class="g-info">
          <p>ç¬¬4ä»£ç©ºä¸­èŠ±å›­æˆ¿</p>
          <p class="price">Piï¼š12</p>
        </div>
      </div>
      <div class="goods-card" onclick="goExchange(8, '8.png', 'æ¬§ç¾åˆ«å¢…', '55')" style="cursor:pointer;">
        <img src="8.png" alt="">
        <div class="g-info">
          <p>æ¬§ç¾åˆ«å¢…</p>
          <p class="price">Piï¼š55</p>
        </div>
      </div>
      <div class="goods-card" onclick="goExchange(9, '9.png', 'æµ·æ™¯åˆ«å¢…', '68')" style="cursor:pointer;">
        <img src="9.png" alt="">
        <div class="g-info">
          <p>æµ·æ™¯åˆ«å¢…</p>
          <p class="price">Piï¼š68</p>
        </div>
      </div>
    </div>
  </section>

  <!-- é’±åŒ… -->
  <section id="wallet" class="page">
    <div class="balance-box">
      <div><span class="label">Piä½™é¢</span><b id="piBal">0</b></div>
      <div><span class="label">USDTä½™é¢</span><b id="usdtBal">0</b></div>
      <div><span class="label">BNBä½™é¢</span><b id="bnbBal">0</b></div>
      <div><span class="label">è´¨æŠ¼æ€»é¢(U)</span><b id="pledgeSum">0</b></div>
    </div>

    <!-- è´¨æŠ¼è¡¨å• -->
    <div class="stake-box">
      <div style="display:flex;gap:10px;margin-bottom:10px;">
        <button onclick="selectStakeAmount(30)" id="btn1" style="flex:1;padding:12px;border:2px solid var(--primary);border-radius:8px;background:transparent;color:var(--primary);cursor:pointer;">30U</button>
        <button onclick="selectStakeAmount(100)" id="btn2" style="flex:1;padding:12px;border:2px solid var(--primary);border-radius:8px;background:transparent;color:var(--primary);cursor:pointer;">100U</button>
        <button onclick="selectStakeAmount(200)" id="btn3" style="flex:1;padding:12px;border:2px solid var(--primary);border-radius:8px;background:transparent;color:var(--primary);cursor:pointer;">200U</button>
      </div>
      <input id="stakeAmount" type="number" placeholder="é€‰æ‹©è´¨æŠ¼æ¡£ä½" readonly style="margin-bottom:10px;">
      <button onclick="stake()">è´¨æŠ¼</button>
      <button onclick="claim()" style="background:#4caf50;">é¢†å–Pi</button>
      <p id="inviterTip" style="font-size:12px;color:#06c"></p>
      <p id="tips"></p>
    </div>



    <div class="tabs">
      <a href="#" class="on">24å°æ—¶</a>
      <a href="#">7å¤©</a>
      <a href="#">30å¤©</a>
      <a href="#">90å¤©</a>
      <a href="#">1å¹´</a>
      <a href="#">å…¨éƒ¨</a>
    </div>

    <div class="chart">
      <h2>Pi<span id="myPoint">0.00</span> <small id="myPointAdd" style="color:#4caf50;">ä»·å€¼: 0.00 U</small></h2>
      <div style="text-align:center;margin:20px 0;">
        <img id="walletMedalImg" src="0xz.png" alt="å‹‹ç« " style="width:120px;margin:0 auto;animation:pulse 3s infinite ease-in-out;">
      </div>
      <img src="kx.png" alt="æŠ˜çº¿å›¾å ä½">
    </div>
  </section>

  <!-- å¹³å°å…¬å‘Šé¡µ -->
  <section id="notice" class="page">
    <div style="display:flex;align-items:center;margin-bottom:20px;">
      <a href="#home" style="font-size:24px;margin-right:12px;">â€¹</a>
      <h2 style="font-size:18px;font-weight:700;">å¹³å°å…¬å‘Š</h2>
    </div>

    <div style="background:var(--card-bg);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow);">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <h3 style="font-size:16px;font-weight:700;">å…¬å‘Š</h3>
        <small style="color:#999;">2025-12-01 20:09</small>
      </div>
      <div style="line-height:1.8;color:#333;font-size:14px;white-space:pre-line;">
ğŸ’¥Starmaxåœ¨piç”Ÿæ€é»‘å®¢é©¬æ‹‰æ¾ç¬¬äºŒåæˆ‘ä»¬å•†åŸå·²å¼€æ”¾æ”¯æŒGCV314159ğŸ’²
è·å–piå¸å•†åŸå¯ä»¥éšæ„è´­ç‰©â—ï¸â—ï¸åŒ…å«:é»„é‡‘ï¼Œç‰çŸ³ï¼Œè±ªè½¦ï¼Œæˆ¿å±‹ï¼
DAPPä¹Ÿå¯ä»¥è´¨æŠ¼æŒ–çŸ¿å¯è·å¾—piå¸  ç®—åˆ©ï¼
1ï¸âƒ£é»„é‡‘æƒç›Š:30u  è·å¾—æ¯å¤©0.01pi ç®—åˆ©
2ï¸âƒ£:ç –çŸ³æƒç›Š:100u è·å¾—æ¯å¤©0.045pi ç®—åˆ©
3ï¸âƒ£:é»‘ç –æƒç›Š:200u  è·å¾—æ¯å¤©0.098piç®—åˆ©

ğŸš«å¤‡æ³¨:ä»¥ä¸Šè´¨æŠ¼å¯ä»¥ç´¯è®¡ï¼
ğŸ”¥é‚€è¯·å¥–åŠ± è·å¾—é»‘ç –æƒç›Š  æ¨è10äºº  å¥–åŠ±0.005piæ”¶ç›Šä»¥æ­¤ç±»æ¨ï¼
ğŸ˜ä¸€æ¬¡æ€§æŠ•èµ„æ°¸ä¹…å›æŠ¥ï¼Œæ‰€æœ‰æŒ–çŸ¿æ‰€å¾—çš„piå¸ åæœŸéƒ½å¯ä»¥æå–åˆ°å„å¤§äº¤æ˜“æ‰€ï¼

DAPPé“¾æ¥:
https://pistake.github.io/Pi.github.io/

å¤§å®¶è¯·å¤åˆ¶åˆ°TPé’±åŒ…ï¼Œç„¶åç‚¹å‡»  å‘ç°ç‚¹å¼€ï¼Œåœ¨é“¾æ¥é’±åŒ…å°±å¯ä»¥äº†ï¼
      </div>
    </div>
  </section>

  <!-- è´¨æŠ¼è¯¦æƒ…é¡µ -->
  <section id="pledge" class="page">
    <div style="display:flex;align-items:center;margin-bottom:20px;">
      <a href="#home" style="font-size:24px;margin-right:12px;">â€¹</a>
      <h2 style="font-size:18px;font-weight:700;">è´¨æŠ¼</h2>
    </div>

    <div style="background:var(--card-bg);border-radius:var(--radius);padding:32px 20px;text-align:center;box-shadow:var(--shadow);">
      <h1 style="font-size:42px;color:var(--primary);font-weight:700;" id="pledgeAmount">0.000000</h1>
      <p style="margin-top:10px;color:var(--gray);">æˆ‘çš„(USDT)è´¨æŠ¼æ•°é‡</p>
    </div>

    <h3 style="font-size:16px;font-weight:700;margin:20px 0 10px;">è´¨æŠ¼è®°å½•</h3>
    <div style="background:var(--card-bg);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow);min-height:200px;">
      <p id="pledgeHistory" style="text-align:center;color:#999;">æš‚æ— è´¨æŠ¼è®°å½•</p>
    </div>

    <button onclick="location.hash='#wallet'" style="width:100%;margin-top:30px;padding:14px 0;border:none;border-radius:28px;background:linear-gradient(135deg,var(--primary),var(--sub));color:#fff;font-size:16px;font-weight:700;cursor:pointer;">å»è´¨æŠ¼</button>
  </section>

  <!-- Piè¯¦æƒ…é¡µ -->
  <section id="points" class="page">
    <div style="display:flex;align-items:center;margin-bottom:24px;">
      <a href="#home" style="font-size:24px;margin-right:12px;text-decoration:none;color:#333;">â€¹</a>
      <h2 style="font-size:18px;font-weight:700;margin:0;">Pi</h2>
    </div>

    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:24px;">
      <div style="background:var(--card-bg);border-radius:var(--radius);padding:18px 12px;text-align:center;box-shadow:var(--shadow);min-height:100px;display:flex;flex-direction:column;justify-content:center;">
        <h2 style="font-size:26px;color:#4caf50;font-weight:700;margin:0;" id="pointsClaimed">0</h2>
        <p style="margin-top:6px;color:var(--gray);font-size:12px;margin:0;">å·²é¢†å–</p>
      </div>
      <div style="background:var(--card-bg);border-radius:var(--radius);padding:18px 12px;text-align:center;box-shadow:var(--shadow);min-height:100px;display:flex;flex-direction:column;justify-content:center;">
        <h2 style="font-size:26px;color:#ff9800;font-weight:700;margin:0;" id="pointsPending">0</h2>
        <p style="margin-top:6px;color:var(--gray);font-size:12px;margin:0;">å¾…é¢†å–</p>
      </div>
      <div style="background:var(--card-bg);border-radius:var(--radius);padding:18px 12px;text-align:center;box-shadow:var(--shadow);min-height:100px;display:flex;flex-direction:column;justify-content:center;">
        <h2 style="font-size:26px;color:var(--primary);font-weight:700;margin:0;" id="pointsTotal">0</h2>
        <p style="margin-top:6px;color:var(--gray);font-size:12px;margin:0;">æ€»ä½™é¢</p>
      </div>
    </div>

    <button onclick="claimFromPointsPage()" style="width:100%;padding:14px 0;border:none;border-radius:28px;background:linear-gradient(135deg,var(--primary),var(--sub));color:#fff;font-size:16px;font-weight:700;cursor:pointer;margin-bottom:24px;transition:all 0.3s;box-shadow:0 2px 8px rgba(112,52,255,0.3);" onmousedown="this.style.transform='scale(0.98)'" onmouseup="this.style.transform='scale(1)'" onmouseleave="this.style.transform='scale(1)'">é¢†å–Pi</button>

    <h3 style="font-size:16px;font-weight:700;margin:0 0 12px 0;color:#222;">Piæ˜ç»†</h3>
    <div id="pointsHistory" style="background:var(--card-bg);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);min-height:200px;">
      <p style="text-align:center;color:#999;margin:0;padding:40px 0;">æš‚æ— è®°å½•</p>
    </div>
  </section>

  <!-- å›¢é˜Ÿæˆå‘˜åˆ—è¡¨é¡µ -->
  <section id="team-list" class="page">
    <div style="display:flex;align-items:center;margin-bottom:20px;">
      <a href="#mine" style="font-size:24px;margin-right:12px;">â€¹</a>
      <h2 style="font-size:18px;font-weight:700;" id="teamListTitle">å›¢é˜Ÿæˆå‘˜</h2>
    </div>

    <div id="teamMemberList" style="background:var(--card-bg);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);min-height:200px;">
      <p style="text-align:center;color:#999;">åŠ è½½ä¸­...</p>
    </div>
  </section>

  <!-- å…‘æ¢é¡µé¢ -->
  <section id="exchange" class="page">
    <div style="display:flex;align-items:center;margin-bottom:20px;">
      <a href="#mall" style="font-size:24px;margin-right:12px;">â€¹</a>
      <h2 style="font-size:18px;font-weight:700;">å•†å“å…‘æ¢</h2>
    </div>

    <div style="background:var(--card-bg);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow);margin-bottom:20px;">
      <img id="exchangeGoodsImg" src="" alt="å•†å“å›¾ç‰‡" style="width:100%;border-radius:var(--radius);margin-bottom:16px;">
      <div>
        <p style="font-size:14px;color:#666;margin-bottom:4px;">å…‘æ¢ä»·æ ¼</p>
        <p style="font-size:20px;font-weight:700;color:var(--primary);" id="exchangeGoodsPrice">Piï¼š-</p>
      </div>
    </div>

    <div style="background:var(--card-bg);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow);margin-bottom:20px;">
      <h3 style="font-size:16px;font-weight:700;margin-bottom:16px;">æ”¶è´§åœ°å€</h3>
      <input id="exchangeAddress" type="text" placeholder="è¯·è¾“å…¥æ”¶è´§åœ°å€" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:14px;box-sizing:border-box;margin-bottom:12px;">
      <input id="exchangeName" type="text" placeholder="è¯·è¾“å…¥æ”¶è´§äººå§“å" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:14px;box-sizing:border-box;margin-bottom:12px;">
      <input id="exchangePhone" type="text" placeholder="è¯·è¾“å…¥è”ç³»ç”µè¯" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:14px;box-sizing:border-box;">
    </div>

    <button onclick="submitExchange()" style="width:100%;padding:14px 0;border:none;border-radius:28px;background:linear-gradient(135deg,var(--primary),var(--sub));color:#fff;font-size:16px;font-weight:700;cursor:pointer;">å…‘æ¢</button>
    
    <p id="exchangeTips" style="text-align:center;color:#999;font-size:14px;margin-top:16px;"></p>
  </section>

  <!-- æˆ‘çš„ -->
  <section id="mine" class="page">
    <div class="profile-box">
      <img id="avatarImg" class="avatar" src="0xz.png" alt="avatar å ä½">
      <div style="display:flex;align-items:center;justify-content:center;gap:10px;margin-top:12px;flex-wrap:wrap;">
        <span id="vipBadge" style="display:inline-flex;align-items:center;justify-content:center;gap:4px;padding:6px 14px;border-radius:20px;background:#e0e0e0;color:#999;font-size:13px;font-weight:700;transition:all 0.3s;" title="æ™®é€šç”¨æˆ·">
          <span style="font-size:16px;">ğŸ‘‘</span>
          <span>VIP</span>
        </span>
      </div>
      <p class="uid" id="myAddr" style="margin-top:12px;">æœªè¿æ¥</p>
      <p class="addr" id="myAddrShort" style="margin-top:6px;"></p>
    </div>

    <div class="invite-box">
      <img id="inviteQrImg" src="0xz.png" alt="äºŒç»´ç å ä½">
      <div class="inv-info">
        <small>é‚€è¯·ç </small>
        <p class="code" id="inviteCode">-</p>
        <input id="shareLink" readonly onclick="copyLink()" />
      </div>
    </div>

    <h3 class="title">å›¢é˜Ÿç®¡ç†</h3>
    <div class="grid-2 team">
      <div class="t-card" onclick="showTeamMembers(1)" style="cursor:pointer;"><b id="teamLv1">0äºº</b><p>ä¸€çº§æˆå‘˜</p></div>
      <div class="t-card"><b id="medalInfo">-</b><p>å‹‹ç« ä¿¡æ¯</p></div>
    </div>

    <h3 class="title" style="margin-top:24px;">æˆ‘çš„è®¢å•</h3>
    <div style="background:var(--card-bg);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);min-height:100px;margin-bottom:20px;">
      <div id="orderList" style="text-align:center;color:#999;">åŠ è½½ä¸­...</div>
    </div>
    <button onclick="location.hash='#orders'" style="width:100%;padding:12px 0;border:none;border-radius:24px;background:linear-gradient(135deg,var(--primary),var(--sub));color:#fff;font-size:14px;font-weight:700;cursor:pointer;">æŸ¥çœ‹å…¨éƒ¨è®¢å•</button>

  </section>

  <!-- è®¢å•åˆ—è¡¨é¡µ -->
  <section id="orders" class="page">
    <div style="display:flex;align-items:center;margin-bottom:20px;">
      <a href="#mine" style="font-size:24px;margin-right:12px;">â€¹</a>
      <h2 style="font-size:18px;font-weight:700;">æˆ‘çš„è®¢å•</h2>
    </div>

    <div id="allOrdersList" style="background:var(--card-bg);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);min-height:200px;">
      <p style="text-align:center;color:#999;">åŠ è½½ä¸­...</p>
    </div>
  </section>

  <!-- èµ„è®¯å¹³å° -->
  <section id="consult" class="page">
    <h3 class="title">èµ„è®¯å¹³å°</h3>
    
    <div class="video-list">
      <!-- è§†é¢‘ 1 -->
      <div class="video-item">
        <div class="video-container">
          <video class="video-player" controls preload="metadata" poster="">
            <source src="https://github.com/PiSTAKE/Pi.github.io/releases/download/v1.0-video/1.mp4" type="video/mp4">
            æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚
          </video>
        </div>
        <div class="video-info">
          <h4 class="video-title">æˆé›•è®ºç”Ÿæ€1</h4>
          <p class="video-desc">æˆé›•è®ºç”Ÿæ€1</p>
        </div>
      </div>

      <!-- è§†é¢‘ 2 -->
      <div class="video-item">
        <div class="video-container">
          <video class="video-player" controls preload="metadata" poster="">
            <source src="https://github.com/PiSTAKE/Pi.github.io/releases/download/v1.0-video/2.mp4" type="video/mp4">
            æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚
          </video>
        </div>
        <div class="video-info">
          <h4 class="video-title">æˆé›•è®ºç”Ÿæ€2</h4>
          <p class="video-desc">æˆé›•è®ºç”Ÿæ€2</p>
        </div>
      </div>
    </div>
  </section>

  <!-- æœ¬åœ°ç”Ÿæ´» -->
  <section id="local" class="page">
    <h3 class="title">æœ¬åœ°ç”Ÿæ´»</h3>
    
    <div class="coming-soon-box">
      <div class="coming-soon-icon">ğŸš§</div>
      <h2 class="coming-soon-title">å¾…å¼€æ”¾</h2>
      <p class="coming-soon-desc">è®©Piå•†åŸèµ°è¿›å¾®å‹ä¼ä¸šï¼Œåƒå®¶ä¸‡æˆ·ï¼</p>
      <p class="coming-soon-desc" style="margin-top:8px;">åŠŸèƒ½ç­‰å¾…å¼€æ”¾ï¼Œæ•¬è¯·æœŸå¾…...</p>
    </div>
  </section>

  <!-- åº•éƒ¨å¯¼èˆª -->
  <nav class="tab-bar">
    <a href="#home" class="tab on">é¦–é¡µ</a>
    <a href="#mall" class="tab">å•†åŸ</a>
    <a href="#local" class="tab">æœ¬åœ°ç”Ÿæ´»</a>
    <a href="#wallet" class="tab">é’±åŒ…</a>
    <a href="#mine" class="tab">æˆ‘çš„</a>
    <a href="#consult" class="tab">èµ„è®¯å¹³å°</a>
  </nav>

  <!-- ethers.js -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script>
    /* -------- hash é¡µé¢åˆ‡æ¢ -------- */
    function switchPage(){
      const hash = location.hash || '#home';
      document.querySelectorAll('.page').forEach(p=>p.classList.toggle('active', '#'+p.id===hash));
      document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('on', t.getAttribute('href')===hash));
    }
    window.addEventListener('hashchange', switchPage);switchPage();
    
    // åˆå§‹åŒ–å‹‹ç« æ˜¾ç¤ºï¼ˆé»˜è®¤å›¾ç‰‡ï¼‰
    function initMedalDisplay(){
      const medalContainer = document.getElementById('medalContainer');
      if(medalContainer && medalContainer.children.length === 0){
        const defaultImg = document.createElement('img');
        defaultImg.src = '0xz.png';
        defaultImg.alt = 'é»˜è®¤å‹‹ç« ';
        defaultImg.style.width = '150px';
        defaultImg.style.margin = '0 auto';
        medalContainer.appendChild(defaultImg);
      }
      // é’±åŒ…é¡µé¢çš„å‹‹ç« å›¾ç‰‡å·²åœ¨HTMLä¸­è®¾ç½®é»˜è®¤å€¼ï¼Œæ— éœ€é¢å¤–åˆå§‹åŒ–
    }
    initMedalDisplay();

    /* -------- é“¾å‚æ•° -------- */
    const contractAddress = "0x11c104Ad363aed73cA2D6c8233A9F4dD24815F0b";
    const usdtAddress     = "0x55d398326f99059fF775485246999027B3197955";
    const abi=[
      "function stake(uint256,address)","function claim()",
      "function medalsOf(address) view returns(uint256,uint256,uint256)",
      "function piBalanceOf(address) view returns(uint256)",
      "function pendingPi(address) view returns(uint256)",
      "function totalStakedOf(address) view returns(uint256)",
      "function getLevel1Members(address) view returns(address[])",
      "function getLevel1Count(address) view returns(uint256)",
      "function getStakeRecords(address) view returns(tuple(uint256,uint256,uint256)[])",
      "function getClaimRecords(address) view returns(tuple(uint256,uint256)[])",
      "function getGlobalMedalCount() view returns(uint256)",
      "function getRegionGoldMedalCount() view returns(uint256)",
      "function userInfo(address) view returns(uint256,uint256,uint256,bool,uint256,uint256,uint256,address,uint256)",
      "function DECIMALS() view returns(uint256)",
      "function exchangeProduct(uint256,string,string,string)",
      "function getOrders(address) view returns(tuple(uint256,uint256,uint8,uint256,string,string,string)[])",
      "function getOrderCount(address) view returns(uint256)",
      "function getOrderDetail(address,uint256) view returns(uint256,uint256,uint8,uint256,string,string,string,string)",
      "function getOrderStatus(address,uint256) view returns(uint8)",
      "function getProductPrices() view returns(uint256[14])",
      "function getShippingFromAddress() view returns(string)",
      "event Staked(address indexed user,uint256 amountU,uint256 medal)",
      "event Claimed(address indexed user,uint256 piSelf,uint256 piLv1,uint256 piLv2)",
      "event OrderCreated(address indexed user,uint256 indexed orderIndex,uint256 productIndex,uint256 pricePi)"
    ];
    let provider,signer,contract,myAddr;

    function getQuery(key){const url=new URL(location.href);return url.searchParams.get(key);} 
    const inviterParam=getQuery('inviter');
    if(inviterParam){
      const tipEl=document.getElementById('inviterTip');
      tipEl.innerText='å·²æ£€æµ‹åˆ°é‚€è¯·äººï¼š'+inviterParam.slice(0,6)+'...'+inviterParam.slice(-4);
    } 
    function copyLink(){const inp=document.getElementById('shareLink');inp.select();document.execCommand('copy');alert('å·²å¤åˆ¶é‚€è¯·é“¾æ¥');}

    async function connectWallet(){ if(!window.ethereum){return alert('è¯·å®‰è£… MetaMask');}
      try{
        await ethereum.request({method:'eth_requestAccounts'});
        provider=new ethers.providers.Web3Provider(window.ethereum);
        signer=provider.getSigner();
        myAddr=await signer.getAddress();
        // åªæ˜¾ç¤ºç¼©çŸ­çš„åœ°å€
        document.getElementById('myAddr').innerText=myAddr.slice(0,6)+'...'+myAddr.slice(-4);
        document.getElementById('myAddrShort').style.display='none';
        document.getElementById('inviteCode').innerText=myAddr.slice(0,6)+'...'+myAddr.slice(-4);
        document.getElementById('shareLink').value=`${location.origin}${location.pathname}?inviter=${myAddr}`;
        const btn=document.getElementById('btnConnect');btn.classList.add('connected');btn.innerText='âœ”';btn.title='å·²è¿æ¥';
        contract=new ethers.Contract(contractAddress,abi,signer);
        // è·å–USDTå°æ•°ä½
        try{
          usdtDecimals = await contract.DECIMALS();
        }catch(e){
          console.log('æ— æ³•è·å–DECIMALSï¼Œä½¿ç”¨é»˜è®¤å€¼18');
        }
        loadData();
      }catch(e){console.log(e)} }

    let usdtDecimals = 18; // é»˜è®¤å€¼ï¼Œä¼šåœ¨è¿æ¥é’±åŒ…æ—¶è·å–

    async function showTeamMembers(level){
      if(!contract)return alert('è¯·è¿æ¥é’±åŒ…');
      if(level !== 1) return; // åˆçº¦åªæœ‰ä¸€çº§æˆå‘˜
      location.hash='#team-list';
      document.getElementById('teamListTitle').innerText='ä¸€çº§æˆå‘˜';
      const listEl=document.getElementById('teamMemberList');
      listEl.innerHTML='<p style="text-align:center;color:#999">åŠ è½½ä¸­...</p>';
      try{
        const members=await contract.getLevel1Members(myAddr);
        if(!members.length){listEl.innerHTML='<p style="text-align:center;color:#999">æš‚æ— æˆå‘˜</p>';return;}
        let html='<ul style="list-style:none;padding:0">';
        for(let addr of members){
          const staked=await contract.totalStakedOf(addr);
          const stakedU=ethers.utils.formatUnits(staked,usdtDecimals);
          html+=`<li style="padding:12px 0;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center">
            <span style="font-size:13px;color:#666">${addr.slice(0,6)}...${addr.slice(-4)}</span>
            <span style="font-weight:700;color:var(--primary)">${stakedU} U</span>
          </li>`;
        }
        html+='</ul>';
        listEl.innerHTML=html;
      }catch(e){console.log(e);listEl.innerHTML='<p style="text-align:center;color:#f00">åŠ è½½å¤±è´¥</p>';}
    }

    // æ ¼å¼åŒ–æ•°å­—ï¼Œå»æ‰æœ«å°¾çš„0
    function formatNumber(num){
      const numStr = parseFloat(num).toString();
      if(numStr.includes('.')){
        return numStr.replace(/\.?0+$/, '');
      }
      return numStr;
    }
    
    // æ™ºèƒ½æ ¼å¼åŒ–ï¼Œæ ¹æ®æ•°å€¼å¤§å°é€‰æ‹©åˆé€‚çš„å°æ•°ä½
    function smartFormat(num){
      const numFloat = parseFloat(num);
      if(numFloat === 0) return '0';
      // æå°å€¼ä¸ä½¿ç”¨ç§‘å­¦è®¡æ•°æ³•ï¼Œç»Ÿä¸€æ˜¾ç¤ºåˆ°å°æ•°ç‚¹å5ä½
      if(numFloat < 0.0001) return numFloat.toFixed(5);
      if(numFloat < 1) return formatNumber(numFloat.toFixed(5)); // å°äº1ä¿ç•™5ä½
      if(numFloat < 100) return formatNumber(numFloat.toFixed(4)); // å°äº100ä¿ç•™4ä½
      if(numFloat < 10000) return formatNumber(numFloat.toFixed(2)); // å°äº10000ä¿ç•™2ä½
      return formatNumber(numFloat.toFixed(2)); // å¤§äº10000ä¿ç•™2ä½
    }

    async function loadData(){ if(!contract)return; try{
      const [medalsData,pts,usdtBalRaw,bnbBalRaw,globalMedals,regionMedals]=await Promise.all([
        contract.medalsOf(myAddr),
        contract.piBalanceOf(myAddr),
        (new ethers.Contract(usdtAddress,["function balanceOf(address) view returns(uint256)"],provider)).balanceOf(myAddr),
        provider.getBalance(myAddr),
        contract.getGlobalMedalCount(),
        contract.getRegionGoldMedalCount()
      ]);
      const [goldMedals, diamondMedals, jadeMedals] = medalsData;
      const totalMedals = goldMedals.toNumber() + diamondMedals.toNumber() + jadeMedals.toNumber();
      document.getElementById('myMedals').innerText=totalMedals;
      document.getElementById('medalDetail').innerText=`é»„é‡‘:${goldMedals} é’»çŸ³:${diamondMedals} é»‘é’»:${jadeMedals}`;
      
      // æ ¹æ®æœ€é«˜ç­‰çº§å‹‹ç« æ›´æ–°æ‰€æœ‰ç›¸å…³å›¾ç‰‡
      let highestMedalImg = '0xz.png';
      let highestMedalAlt = 'é»˜è®¤å‹‹ç« ';
      if(jadeMedals.toNumber() > 0){
        highestMedalImg = 'hzxz.png'; // é»‘é’»å‹‹ç« ï¼ˆæœ€é«˜ç­‰çº§ï¼‰
        highestMedalAlt = 'é»‘é’»å‹‹ç« ';
      } else if(diamondMedals.toNumber() > 0){
        highestMedalImg = 'zsxz.png'; // é’»çŸ³å‹‹ç« 
        highestMedalAlt = 'é’»çŸ³å‹‹ç« ';
      } else if(goldMedals.toNumber() > 0){
        highestMedalImg = 'hjxz.png'; // é»„é‡‘å‹‹ç« 
        highestMedalAlt = 'é»„é‡‘å‹‹ç« ';
      }
      
      // æ›´æ–°é’±åŒ…é¡µé¢çš„å‹‹ç« å›¾ç‰‡
      const walletMedalImg = document.getElementById('walletMedalImg');
      if(walletMedalImg){
        walletMedalImg.src = highestMedalImg;
        walletMedalImg.alt = highestMedalAlt;
      }
      
      // æ›´æ–°é¦–é¡µ"è´¨æŠ¼"å¡ç‰‡çš„å›¾ç‰‡
      const pledgeCardImg = document.getElementById('pledgeCardImg');
      if(pledgeCardImg){
        pledgeCardImg.src = highestMedalImg;
        pledgeCardImg.alt = highestMedalAlt;
      }
      
      // æ›´æ–°é¦–é¡µ"Pi"å¡ç‰‡çš„å›¾ç‰‡
      const pointsCardImg = document.getElementById('pointsCardImg');
      if(pointsCardImg){
        pointsCardImg.src = highestMedalImg;
        pointsCardImg.alt = highestMedalAlt;
      }
      
      // æ›´æ–°"æˆ‘çš„"é¡µé¢å¤´åƒå›¾ç‰‡
      const avatarImg = document.getElementById('avatarImg');
      if(avatarImg){
        avatarImg.src = highestMedalImg;
        avatarImg.alt = highestMedalAlt;
      }
      
      // æ›´æ–°"æˆ‘çš„"é¡µé¢é‚€è¯·ç åŒºåŸŸçš„å›¾ç‰‡
      const inviteQrImg = document.getElementById('inviteQrImg');
      if(inviteQrImg){
        inviteQrImg.src = highestMedalImg;
        inviteQrImg.alt = highestMedalAlt;
      }
      
      // æ ¹æ®æ‹¥æœ‰çš„å‹‹ç« ç±»å‹æ˜¾ç¤ºå¯¹åº”çš„å›¾ç‰‡
      const medalContainer = document.getElementById('medalContainer');
      medalContainer.innerHTML = ''; // æ¸…ç©ºå®¹å™¨
      
      if(totalMedals === 0){
        // æ²¡æœ‰å‹‹ç« ï¼Œæ˜¾ç¤ºé»˜è®¤å›¾ç‰‡
        const defaultImg = document.createElement('img');
        defaultImg.src = '0xz.png';
        defaultImg.alt = 'é»˜è®¤å‹‹ç« ';
        defaultImg.style.width = '150px';
        defaultImg.style.margin = '0 auto';
        medalContainer.appendChild(defaultImg);
      } else {
        // æ ¹æ®æ‹¥æœ‰çš„å‹‹ç« ç±»å‹æ˜¾ç¤ºå¯¹åº”çš„å›¾ç‰‡
        if(goldMedals.toNumber() > 0){
          const goldImg = document.createElement('img');
          goldImg.src = 'hjxz.png'; // é»„é‡‘å‹‹ç« å›¾ç‰‡
          goldImg.alt = 'é»„é‡‘å‹‹ç« ';
          goldImg.style.width = '120px';
          goldImg.style.animation = 'pulse 3s infinite ease-in-out';
          medalContainer.appendChild(goldImg);
        }
        if(diamondMedals.toNumber() > 0){
          const diamondImg = document.createElement('img');
          diamondImg.src = 'zsxz.png'; // é’»çŸ³å‹‹ç« å›¾ç‰‡
          diamondImg.alt = 'é’»çŸ³å‹‹ç« ';
          diamondImg.style.width = '120px';
          diamondImg.style.animation = 'pulse 3s infinite ease-in-out';
          medalContainer.appendChild(diamondImg);
        }
        if(jadeMedals.toNumber() > 0){
          const jadeImg = document.createElement('img');
          jadeImg.src = 'hzxz.png'; // é»‘é’»å‹‹ç« å›¾ç‰‡
          jadeImg.alt = 'é»‘é’»å‹‹ç« ';
          jadeImg.style.width = '120px';
          jadeImg.style.animation = 'pulse 3s infinite ease-in-out';
          medalContainer.appendChild(jadeImg);
        }
      }
      const ptsFmt=ethers.utils.formatUnits(pts,18);
      const formattedPts = smartFormat(ptsFmt);
      document.getElementById('piBal').innerText=formattedPts;
      document.getElementById('myPoint').innerText=formattedPts;
      
      // è®¡ç®—å½“å‰Piä»·å€¼å¤šå°‘Uï¼ˆ1 Pi = 314159 Uï¼‰
      const piValueInU = parseFloat(ptsFmt) * 314159;
      const formattedValue = piValueInU >= 1000 ? piValueInU.toFixed(2) : piValueInU.toFixed(4);
      document.getElementById('myPointAdd').innerText = 'ä»·å€¼: ' + formattedValue + ' U';
      
      // è®¡ç®—æ€»è´¨æŠ¼é‡‘é¢
      const [userInfoData,pending,lv1Cnt,totalStaked]=await Promise.all([
        contract.userInfo(myAddr),
        contract.pendingPi(myAddr),
        contract.getLevel1Count(myAddr),
        contract.totalStakedOf(myAddr)
      ]);
      const totalStakedU = parseFloat(ethers.utils.formatUnits(totalStaked,usdtDecimals));
      document.getElementById('myPledgeU').innerText=totalStakedU.toFixed(0)+'U';
      document.getElementById('pledgeAmount').innerText=totalStakedU.toFixed(6);
      document.getElementById('pledgeSum').innerText=totalStakedU.toFixed(2);
      document.getElementById('usdtBal').innerText=parseFloat(ethers.utils.formatUnits(usdtBalRaw,usdtDecimals)).toFixed(2);
      document.getElementById('bnbBal').innerText=parseFloat(ethers.utils.formatEther(bnbBalRaw)).toFixed(4);
      // æ›´æ–°å›¢é˜Ÿæˆå‘˜æ•°é‡
      document.getElementById('teamLv1').innerText=lv1Cnt+'äºº';
      // æ›´æ–°å‹‹ç« ä¿¡æ¯æ˜¾ç¤º
      const medalInfo = `é‡‘${goldMedals} é’»${diamondMedals} é»‘${jadeMedals}`;
      document.getElementById('medalInfo').innerText=medalInfo;
      // æ›´æ–°Piç»Ÿè®¡
      const balance=userInfoData[8]; // piBalance (å·²é¢†å–)
      const balanceFmt = ethers.utils.formatUnits(balance,18);
      const pendingFmt = ethers.utils.formatUnits(pending,18);
      const totalFmt = parseFloat(balanceFmt) + parseFloat(pendingFmt); // æ€»ä½™é¢ = å·²é¢†å– + å¾…é¢†å–
      
      // ä½¿ç”¨æ™ºèƒ½æ ¼å¼åŒ–æ˜¾ç¤ºPiæ•°é‡
      document.getElementById('pointsClaimed').innerText=smartFormat(balanceFmt);
      document.getElementById('pointsPending').innerText=smartFormat(pendingFmt);
      document.getElementById('pointsTotal').innerText=smartFormat(totalFmt.toString());
      
      // æ›´æ–°å…¨çƒå‹‹ç« æ•°é‡å’Œæ‰€åœ¨åœ°åŒºé»„é‡‘å‹‹ç« æ•°é‡
      document.getElementById('totalMedals').innerText=globalMedals.toString();
      document.getElementById('teamMedals').innerText=regionMedals.toString();
      
      // æ›´æ–°VIPçŠ¶æ€æ˜¾ç¤º
      const isSuperVIP = userInfoData[3]; // isSuperVIP (bool)
      const vipBadge = document.getElementById('vipBadge');
      if(vipBadge){
        if(isSuperVIP){
          // é‡‘è‰²VIP - æ›´æ˜æ˜¾çš„æ ·å¼
          vipBadge.style.background = 'linear-gradient(135deg, #FFD700, #FF8C00)';
          vipBadge.style.color = '#fff';
          vipBadge.style.boxShadow = '0 4px 12px rgba(255, 215, 0, 0.6)';
          vipBadge.style.border = '2px solid #FFD700';
          vipBadge.style.fontWeight = '700';
          vipBadge.innerHTML = '<span style="font-size:18px;">ğŸ‘‘</span><span>è¶…çº§VIP</span>';
          vipBadge.title = 'è¶…çº§VIP - äº«å—é¢å¤–æ”¶ç›ŠåŠ æˆ';
        } else {
          // ç°è‰²VIP - æ›´æ˜æ˜¾çš„å¯¹æ¯”
          vipBadge.style.background = '#e0e0e0';
          vipBadge.style.color = '#999';
          vipBadge.style.boxShadow = 'none';
          vipBadge.style.border = '2px solid #d0d0d0';
          vipBadge.style.fontWeight = '600';
          vipBadge.innerHTML = '<span style="font-size:16px;opacity:0.6;">ğŸ‘‘</span><span>VIP</span>';
          vipBadge.title = 'æ™®é€šç”¨æˆ· - æˆä¸ºVIPéœ€è¦é»‘é’»å‹‹ç« +10ä¸ªä¸€çº§æˆå‘˜';
        }
      }
      
      // å¦‚æœå½“å‰åœ¨"æˆ‘çš„"é¡µé¢ï¼ŒåŠ è½½è®¢å•
      if(location.hash === '#mine'){
        await loadOrders();
      }
    }catch(e){console.log(e)}}

    function selectStakeAmount(amount){
      document.getElementById('stakeAmount').value = amount;
      // é‡ç½®æŒ‰é’®æ ·å¼
      ['btn1','btn2','btn3'].forEach(id=>{
        const btn = document.getElementById(id);
        btn.style.background = 'transparent';
        btn.style.color = 'var(--primary)';
      });
      // è®¾ç½®é€‰ä¸­æŒ‰é’®æ ·å¼ï¼ˆæ ¹æ®é‡‘é¢æ‰¾åˆ°å¯¹åº”çš„æŒ‰é’®ï¼‰
      let btnId = '';
      if(amount === 30) btnId = 'btn1';
      else if(amount === 100) btnId = 'btn2';
      else if(amount === 200) btnId = 'btn3';
      if(btnId){
        const selectedBtn = document.getElementById(btnId);
        selectedBtn.style.background = 'var(--primary)';
        selectedBtn.style.color = '#fff';
      }
    }

    async function stake(){ if(!contract)return alert('è¯·è¿æ¥é’±åŒ…');
      const amount=Number(document.getElementById('stakeAmount').value);
      if(amount !== 30 && amount !== 100 && amount !== 200)return tips('è¯·é€‰æ‹©30Uã€100Uæˆ–200Uæ¡£ä½');
      const inviterAddr=getQuery('inviter');const inviter=inviterAddr||ethers.constants.AddressZero;
      const amt=ethers.utils.parseUnits(amount.toString(),usdtDecimals);
      const usdt=new ethers.Contract(usdtAddress,["function approve(address,uint256)"],signer);
      try{tips('approve...');let tx=await usdt.approve(contractAddress,amt);await tx.wait();tips('stake...');tx=await contract.stake(amt,inviter);await tx.wait();tips('æˆåŠŸ');loadData();loadPledgeHistory();document.getElementById('stakeAmount').value='';['btn1','btn2','btn3'].forEach(id=>{const btn=document.getElementById(id);btn.style.background='transparent';btn.style.color='var(--primary)';});}catch(e){console.log(e);tips('å¤±è´¥: '+e.message)}
    }

    async function claim(){ if(!contract)return alert('è¯·è¿æ¥');try{tips('claim...');const tx=await contract.claim();await tx.wait();tips('é¢†å–æˆåŠŸ');loadData();}catch(e){console.log(e);tips('é¢†å–å¤±è´¥')} }
    
    async function claimFromPointsPage(){
      if(!contract)return alert('è¯·è¿æ¥é’±åŒ…');
      try{
        const tx=await contract.claim();
        document.getElementById('pointsHistory').innerHTML='<p style="text-align:center;color:#06c">å¤„ç†ä¸­...</p>';
        await tx.wait();
        alert('é¢†å–æˆåŠŸ');
        loadData();
        loadPointsHistory();
      }catch(e){console.log(e);alert('é¢†å–å¤±è´¥')}
    }

    async function loadPointsHistory(){
      if(!contract)return;
      try{
        const histEl=document.getElementById('pointsHistory');
        histEl.innerHTML='<p style="text-align:center;color:#06c">åŠ è½½ä¸­...</p>';
        
        // ç›´æ¥ä»åˆçº¦æŸ¥è¯¢ç”¨æˆ·é¢†å–è®°å½•ï¼Œé¿å…äº‹ä»¶æŸ¥è¯¢çš„åŒºå—èŒƒå›´é™åˆ¶
        const records=await contract.getClaimRecords(myAddr);
        
        if(!records || records.length === 0){
          histEl.innerHTML='<p style="text-align:center;color:#999">æš‚æ— è®°å½•</p>';
          return;
        }
        
        let html='<ul style="list-style:none;padding:0">';
        // æŒ‰æ—¶é—´å€’åºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
        const sortedRecords = records.slice().sort((a,b)=>{
          const timeA = a.timestamp ? (a.timestamp.toNumber ? a.timestamp.toNumber() : Number(a.timestamp)) : 0;
          const timeB = b.timestamp ? (b.timestamp.toNumber ? b.timestamp.toNumber() : Number(b.timestamp)) : 0;
          return timeB - timeA;
        });
        
        for(let record of sortedRecords){
          try{
            const amountPi = record.amountPi || record[0];
            const timestamp = record.timestamp || record[1];
            
            const amount = ethers.utils.formatUnits(amountPi, 18);
            const timeStamp = timestamp.toNumber ? timestamp.toNumber() * 1000 : Number(timestamp) * 1000;
            const time = new Date(timeStamp).toLocaleString('zh-CN');
            const formattedAmount = smartFormat(amount);
            
          html+=`<li style="padding:12px 0;border-bottom:1px solid #eee">
            <div style="display:flex;justify-content:space-between;margin-bottom:4px">
                <span style="font-weight:700">é¢†å–Pi</span>
                <span style="color:var(--primary);font-weight:700">+${formattedAmount}</span>
              </div>
              <small style="color:#999">${time}</small>
          </li>`;
          }catch(err){
            console.log('å¤„ç†è®°å½•å¤±è´¥:', err);
          }
        }
        html+='</ul>';
        histEl.innerHTML=html;
      }catch(e){
        console.log('åŠ è½½Piæ˜ç»†å¤±è´¥:', e);
        const histEl=document.getElementById('pointsHistory');
        if(histEl) histEl.innerHTML='<p style="text-align:center;color:#f00">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</p>';
      }
    }

    // åŠ è½½è®¢å•åˆ—è¡¨ï¼ˆæˆ‘çš„é¡µé¢æ˜¾ç¤ºæœ€è¿‘3ä¸ªï¼‰
    async function loadOrders(){
      if(!contract || !myAddr) return;
      try{
        const orderCount = await contract.getOrderCount(myAddr);
        const orderCountNum = orderCount.toNumber ? orderCount.toNumber() : Number(orderCount);
        
        if(orderCountNum === 0){
          document.getElementById('orderList').innerHTML = '<p style="text-align:center;color:#999;margin:0;">æš‚æ— è®¢å•</p>';
          return;
        }
        
        // è·å–æ‰€æœ‰è®¢å•
        const orders = await contract.getOrders(myAddr);
        
        // æ˜¾ç¤ºæœ€è¿‘3ä¸ªè®¢å•
        const recentOrders = orders.slice(-3).reverse();
        let html = '<ul style="list-style:none;padding:0">';
        
        for(let i = 0; i < recentOrders.length; i++){
          const order = recentOrders[i];
          const orderIndex = orderCountNum - 1 - i;
          
          try{
            // è·å–è®¢å•è¯¦æƒ…ï¼ˆåŒ…å«å®æ—¶çŠ¶æ€ï¼‰
            const detail = await contract.getOrderDetail(myAddr, orderIndex);
            const productIndex = detail[0].toNumber ? detail[0].toNumber() : Number(detail[0]);
            const pricePi = ethers.utils.formatUnits(detail[1], 18);
            const status = detail[2].toNumber ? detail[2].toNumber() : Number(detail[2]); // 0=å¤‡è´§ä¸­, 1=å‘è´§ä¸­
            const createTime = detail[3].toNumber ? detail[3].toNumber() : Number(detail[3]);
            const shippingAddress = detail[4];
            const receiverName = detail[5];
            
            const time = new Date(createTime * 1000).toLocaleString('zh-CN');
            const statusText = status === 0 ? 'å¤‡è´§ä¸­' : 'å‘è´§ä¸­';
            const statusColor = status === 0 ? '#ff9800' : '#4caf50';
            
            html += `<li style="padding:12px 0;border-bottom:1px solid #eee;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700">å•†å“ #${productIndex + 1}</span>
                <span style="color:${statusColor};font-weight:700;font-size:12px;">${statusText}</span>
              </div>
              <div style="font-size:12px;color:#666;margin-bottom:4px">
                <div>ä»·æ ¼: ${smartFormat(pricePi)} Pi</div>
                <div>æ”¶è´§äºº: ${receiverName}</div>
              </div>
              <small style="color:#999">${time}</small>
            </li>`;
          }catch(err){
            console.log('å¤„ç†è®¢å•å¤±è´¥:', err);
          }
        }
        
        html += '</ul>';
        if(orderCountNum > 3){
          html += `<p style="text-align:center;color:#999;margin-top:8px;font-size:12px;">å…±${orderCountNum}ä¸ªè®¢å•ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æŸ¥çœ‹å…¨éƒ¨</p>`;
        }
        document.getElementById('orderList').innerHTML = html;
      }catch(e){
        console.log('åŠ è½½è®¢å•å¤±è´¥:', e);
        document.getElementById('orderList').innerHTML = '<p style="text-align:center;color:#f00;margin:0;">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</p>';
      }
    }
    
    // åŠ è½½å…¨éƒ¨è®¢å•åˆ—è¡¨
    async function loadAllOrders(){
      if(!contract || !myAddr) return;
      try{
        const orderCount = await contract.getOrderCount(myAddr);
        const orderCountNum = orderCount.toNumber ? orderCount.toNumber() : Number(orderCount);
        
        const listEl = document.getElementById('allOrdersList');
        
        if(orderCountNum === 0){
          listEl.innerHTML = '<p style="text-align:center;color:#999;margin:0;padding:40px 0;">æš‚æ— è®¢å•</p>';
          return;
        }
        
        // è·å–æ‰€æœ‰è®¢å•
        const orders = await contract.getOrders(myAddr);
        const shippingFrom = await contract.getShippingFromAddress();
        
        let html = '<ul style="list-style:none;padding:0">';
        
        // å€’åºæ˜¾ç¤ºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
        for(let i = orders.length - 1; i >= 0; i--){
          const order = orders[i];
          
          try{
            // è·å–è®¢å•è¯¦æƒ…ï¼ˆåŒ…å«å®æ—¶çŠ¶æ€ï¼‰
            const detail = await contract.getOrderDetail(myAddr, i);
            const productIndex = detail[0].toNumber ? detail[0].toNumber() : Number(detail[0]);
            const pricePi = ethers.utils.formatUnits(detail[1], 18);
            const status = detail[2].toNumber ? detail[2].toNumber() : Number(detail[2]); // 0=å¤‡è´§ä¸­, 1=å‘è´§ä¸­
            const createTime = detail[3].toNumber ? detail[3].toNumber() : Number(detail[3]);
            const shippingAddress = detail[4];
            const receiverName = detail[5];
            const receiverPhone = detail[6];
            const shippingFromAddr = detail[7];
            
            const time = new Date(createTime * 1000).toLocaleString('zh-CN');
            const statusText = status === 0 ? 'å¤‡è´§ä¸­' : 'å‘è´§ä¸­';
            const statusColor = status === 0 ? '#ff9800' : '#4caf50';
            
            html += `<li style="padding:16px 0;border-bottom:1px solid #eee;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                <span style="font-weight:700;font-size:16px">å•†å“ #${productIndex + 1}</span>
                <span style="color:${statusColor};font-weight:700;padding:4px 12px;border-radius:12px;background:${statusColor}20;font-size:12px;">${statusText}</span>
              </div>
              <div style="font-size:13px;color:#666;margin-bottom:8px;line-height:1.6">
                <div><strong>ä»·æ ¼:</strong> ${smartFormat(pricePi)} Pi</div>
                <div><strong>æ”¶è´§äºº:</strong> ${receiverName}</div>
                <div><strong>ç”µè¯:</strong> ${receiverPhone}</div>
                <div><strong>æ”¶è´§åœ°å€:</strong> ${shippingAddress}</div>
                <div><strong>å‘è´§åœ°å€:</strong> ${shippingFromAddr}</div>
              </div>
              <small style="color:#999">ä¸‹å•æ—¶é—´: ${time}</small>
            </li>`;
          }catch(err){
            console.log('å¤„ç†è®¢å•å¤±è´¥:', err);
          }
        }
        
        html += '</ul>';
        listEl.innerHTML = html;
      }catch(e){
        console.log('åŠ è½½è®¢å•å¤±è´¥:', e);
        const listEl = document.getElementById('allOrdersList');
        if(listEl) listEl.innerHTML = '<p style="text-align:center;color:#f00;margin:0;padding:40px 0;">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</p>';
      }
    }

    // è¿›å…¥Pié¡µæ—¶åŠ è½½æ˜ç»†ï¼Œè¿›å…¥è´¨æŠ¼é¡µæ—¶åŠ è½½è´¨æŠ¼è®°å½•ï¼Œè¿›å…¥æˆ‘çš„é¡µé¢æ—¶åŠ è½½è®¢å•
    window.addEventListener('hashchange',()=>{
      if(location.hash==='#points')loadPointsHistory();
      if(location.hash==='#pledge')loadPledgeHistory();
      if(location.hash==='#mine')loadOrders();
      if(location.hash==='#orders')loadAllOrders();
    });

    function tips(msg){document.getElementById('tips').innerText=msg;}
    function goPledge(){location.hash='#pledge';loadPledgeHistory();}
    
    // ä¿å­˜å½“å‰å…‘æ¢çš„å•†å“ä¿¡æ¯
    let currentProductIndex = -1;
    let currentProductPrice = '0';
    
    // è·³è½¬åˆ°å…‘æ¢é¡µé¢
    function goExchange(index, imgSrc, date, price){
      currentProductIndex = index;
      currentProductPrice = price;
      document.getElementById('exchangeGoodsImg').src = imgSrc;
      document.getElementById('exchangeGoodsPrice').innerText = 'Piï¼š' + price;
      // æ¸…ç©ºè¾“å…¥æ¡†
      document.getElementById('exchangeAddress').value = '';
      document.getElementById('exchangeName').value = '';
      document.getElementById('exchangePhone').value = '';
      document.getElementById('exchangeTips').innerText = '';
      location.hash = '#exchange';
    }
    
    // æäº¤å…‘æ¢
    async function submitExchange(){
      if(!contract){
        alert('è¯·å…ˆè¿æ¥é’±åŒ…');
        return;
      }
      
      const address = document.getElementById('exchangeAddress').value.trim();
      const name = document.getElementById('exchangeName').value.trim();
      const phone = document.getElementById('exchangePhone').value.trim();
      
      if(!address || !name || !phone){
        document.getElementById('exchangeTips').innerText = 'è¯·å¡«å†™å®Œæ•´çš„æ”¶è´§ä¿¡æ¯';
        document.getElementById('exchangeTips').style.color = '#f00';
        return;
      }
      
      if(currentProductIndex < 0 || currentProductIndex >= 14){
        document.getElementById('exchangeTips').innerText = 'å•†å“ä¿¡æ¯é”™è¯¯';
        document.getElementById('exchangeTips').style.color = '#f00';
        return;
      }
      
      try{
        document.getElementById('exchangeTips').innerText = 'å¤„ç†ä¸­...';
        document.getElementById('exchangeTips').style.color = '#06c';
        
        // è°ƒç”¨åˆçº¦å…‘æ¢å‡½æ•°
        const tx = await contract.exchangeProduct(
          currentProductIndex,
          address,
          name,
          phone
        );
        
        document.getElementById('exchangeTips').innerText = 'äº¤æ˜“å·²æäº¤ï¼Œç­‰å¾…ç¡®è®¤...';
        await tx.wait();
        
        document.getElementById('exchangeTips').innerText = 'å…‘æ¢æˆåŠŸï¼';
        document.getElementById('exchangeTips').style.color = '#4caf50';
        
        // å¼¹çª—æç¤ºå…‘æ¢æˆåŠŸ
        alert(`ğŸ‰ æ­å–œï¼\n\næ‚¨å·²æˆåŠŸèŠ±è´¹ ${currentProductPrice} Pi å…‘æ¢å•†å“ï¼\n\nè®¢å•å·²åˆ›å»ºï¼Œè¯·å‰å¾€"æˆ‘çš„"é¡µé¢æŸ¥çœ‹è®¢å•çŠ¶æ€ã€‚`);
        
        // åˆ·æ–°æ•°æ®
        await loadData();
        await loadOrders();
        
        // 3ç§’åè¿”å›å•†åŸ
        setTimeout(() => {
          location.hash = '#mall';
        }, 3000);
      }catch(e){
        console.error('å…‘æ¢å¤±è´¥:', e);
        let errorMsg = 'å…‘æ¢å¤±è´¥';
        if(e.message){
          if(e.message.includes('ä½™é¢ä¸è¶³')){
            errorMsg = 'Piä½™é¢ä¸è¶³';
          }else if(e.message.includes('user rejected')){
            errorMsg = 'ç”¨æˆ·å–æ¶ˆäº¤æ˜“';
          }else{
            errorMsg = e.message;
          }
        }
        document.getElementById('exchangeTips').innerText = errorMsg;
        document.getElementById('exchangeTips').style.color = '#f00';
      }
    }
    
    async function loadPledgeHistory(){
      if(!contract)return;
      try{
        const records=await contract.getStakeRecords(myAddr);
        const histEl=document.getElementById('pledgeHistory');
        if(!records || records.length === 0){
          histEl.innerHTML='<p style="text-align:center;color:#999">æš‚æ— è´¨æŠ¼è®°å½•</p>';
          return;
        }
        let html='<ul style="list-style:none;padding:0">';
        records.forEach((record, index)=>{
          try{
            // å¤„ç†tupleè¿”å›çš„æ•°æ®ç»“æ„
            const amountU = record.amountU || record[0];
            const medals = record.medals || record[1];
            const timestamp = record.timestamp || record[2];
            
            const amt = ethers.utils.formatUnits(amountU, usdtDecimals);
            const medal = medals.toString();
            const timeStamp = timestamp.toNumber ? timestamp.toNumber() * 1000 : Number(timestamp) * 1000;
            const time = new Date(timeStamp).toLocaleString();
            
            let medalType = '';
            const amtNum = parseFloat(amt);
            if(Math.abs(amtNum - 30) < 0.01) medalType = 'é»„é‡‘';
            else if(Math.abs(amtNum - 100) < 0.01) medalType = 'é’»çŸ³';
            else if(Math.abs(amtNum - 200) < 0.01) medalType = 'é»‘é’»';
            
          html+=`<li style="padding:10px 0;border-bottom:1px solid #eee">
            <div style="display:flex;justify-content:space-between">
              <span>è´¨æŠ¼ ${amt} USDT</span>
                <span style="color:var(--primary)">${medalType}å‹‹ç«  x${medal}</span>
            </div>
            <small style="color:#999">${time}</small>
          </li>`;
          }catch(err){
            console.log('å¤„ç†è®°å½•å¤±è´¥:', index, err);
          }
        });
        html+='</ul>';
        histEl.innerHTML=html;
      }catch(e){
        console.log('åŠ è½½è´¨æŠ¼è®°å½•å¤±è´¥:', e);
        const histEl=document.getElementById('pledgeHistory');
        if(histEl) histEl.innerHTML='<p style="text-align:center;color:#f00">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</p>';
      }
    }

  </script>
</body>
</html>
